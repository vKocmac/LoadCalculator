<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Υπολογισμός Φορτίων – Ψύξη / Θέρμανση</title>
  <style>
    :root {
      --bg: #0b1020; --card: #161b2e; --ink: #ecf1ff; --muted: #a8b0c9;
      --accent: #7c5cff; --accent-2: #2fe4a7; --danger: #ff6b6b; --border: #232a45;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 800px at 80% -10%, #1a1f35 0%, var(--bg) 45%),var(--bg);color:var(--ink);padding:16px;}
    .wrap{max-width:1100px;margin:0 auto}
    h1{font-size:1.25rem;margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:14px}
    .card{background:linear-gradient(180deg,#181e32 0%,var(--card) 100%);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.cols-3{grid-template-columns:repeat(3,1fr)}.cols-2{grid-template-columns:repeat(2,1fr)}}
    label{display:block;color:var(--muted);font-size:.9rem;margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0d1326;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.18)}
    .btn{cursor:pointer;border:0}
    .primary{background:linear-gradient(90deg,var(--accent) 0%,#5a3dff 100%);color:white}
    .ghost{background:transparent}
    .kpi{display:grid;gap:4px;padding:12px;border:1px dashed var(--border);border-radius:12px;background:#0e1428}
    .kpi b{font-size:1.2rem;color:var(--accent-2)}
    .rowline{display:flex;justify-content:space-between;gap:8px;border-bottom:1px dashed #222a48;padding:6px 0}
    .muted{color:var(--muted)}
    .section{margin-top:14px}
    .section h2{font-size:1rem;margin:0 0 6px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1833;border:1px solid var(--border);font-size:.75rem;color:var(--muted)}
    .warn{border-left:3px solid #ffd166;background:#2a2233;border-radius:10px;color:#ffd166;padding:8px 10px;font-size:.85rem}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px dashed #222a48;padding:6px 8px;text-align:left}
    .right{text-align:right}
    canvas{max-width:100%;background:#0d1326;border:1px solid var(--border);border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Tabs bar (non-intrusive) -->
    <div id="tabsBar" class="tabs" style="position:sticky;top:0;z-index:50;margin-bottom:10px;display:flex;gap:6px;align-items:center;">
      <button id="tabLoads" class="btn ghost" style="border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#0d1326;color:var(--ink)">Φορτία</button>
      <button id="tabPsychro" class="btn ghost" style="border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#0d1326;color:var(--ink)">Ψυχρομετρία (beta)</button>
      
    </div>
    <div class="card">
      <h1>Υπολογισμός Φορτίων / Απωλειών – Ψύξη / Θέρμανση</h1>
    

      <!-- Λειτουργία -->
      <div class="section">
        <h2>Λειτουργία</h2>
        <div class="grid cols-3">
          <div>
            <label>Επιλογή</label>
            <select id="Mode">
              <option value="cool" selected>Ψύξη</option>
              <option value="heat">Θέρμανση</option>
            </select>
          </div>
          <div>
            <label>Μονάδες</label>
            <select id="Units">
              <option value="W" selected>W</option>
              <option value="kW">kW</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Βασική γεωμετρία -->
      <div class="section">
        <h2>Γεωμετρία</h2>
        <div class="grid cols-3">
          <div><label>Μήκος (m)</label><input type="number" id="L" step="0.1" value="6"></div>
          <div><label>Πλάτος (m)</label><input type="number" id="W" step="0.1" value="4.5"></div>
          <div><label>Ύψος (m)</label><input type="number" id="H" step="0.1" value="2.8"></div>
        </div>
      </div>

      <!-- Συνθήκες σχεδιασμού -->
      <div class="section">
        <h2>Συνθήκες Σχεδιασμού</h2>
        <div class="grid cols-3">
          <div><label>Εσωτερική Θερμ. (°C)</label><input id="Tin" type="number" step="0.1" value="24"></div>
          <div><label>Εσωτερική RH (%)</label><input id="RHin" type="number" step="1" value="45"></div>
          <div><label>Πόλη (ενδεικτικό)</label>
            <select id="city">
              <option value="Athens|36|40">Αθήνα (T=36, RH=40%)</option>
              <option value="Thessaloniki|35|50">Θεσσαλονίκη (35, 50%)</option>
              <option value="Patra|34|55">Πάτρα (34, 55%)</option>
              <option value="Heraklion|33|60">Ηράκλειο (33, 60%)</option>
              <option value="Custom">Custom</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:8px">
          <div><label>Εξωτερική Θερμ. (°C)</label><input id="Tout" type="number" step="0.1" value="36"></div>
          <div><label>Εξωτερική RH (%)</label><input id="RHout" type="number" step="1" value="40"></div>
        </div>
      </div>

      <!-- Τοίχοι -->
      <div class="section">
        <h2>Τοίχοι</h2>
        <div class="grid cols-3">
          <div>
            <label>U τοίχου</label>
            <select id="UwallPreset">
              <option value="1.80">Τοιχοποιία παλαιά (U≈1.80)</option>
              <option value="1.20">Τούβλο 10cm + σοβάδες (U≈1.20)</option>
              <option value="1.00">Διπλή τοιχοποιία χωρίς μόνωση (U≈1.00)</option>
              <option value="0.70">Μόνωση ~5cm EPS (U≈0.70)</option>
              <option value="0.45">Μόνωση ~8cm EPS (U≈0.45)</option>
              <option value="0.35">Μόνωση ~10cm EPS (U≈0.35)</option>
              <option value="0.30">Μόνωση ~12cm EPS (U≈0.30)</option>
              <option value="custom">Custom</option>
</select>
          </div>
          <div><label>U wall custom</label><input id="UwallCustom" type="number" step="0.01" value="0.70" disabled></div>
          <div><label>Μήκος προς εξωτερικό (m)</label><input id="LwallExt" type="number" step="0.1" value="8"></div>
        </div>
        <div class="grid cols-3" style="margin-top:8px">
          <div><label>Μήκος προς μη θερμαινόμενο (m)</label><input id="LwallUnh" type="number" step="0.1" value="0"></div>
          <div><label>T γειτονικού μη θερμ. (°C)</label><input id="Tadj" type="number" step="0.5" value="30"></div>
          <div><label>Ύψος χώρου (από πάνω)</label><input id="H_display" type="number" value="2.8" disabled></div>
        </div>
      </div>

      <!-- Παράθυρα πολλαπλών προσανατολισμών -->
      <div class="section">
        <h2>Παράθυρα</h2>
        <div class="grid cols-3">
          <div>
            <label>U υαλοπινάκων</label>
            <select id="UwinPreset">
              <option value="5.7">Μονό clear (U≈5.7)</option>
              <option value="2.8" selected>Διπλό clear (U≈2.8)</option>
              <option value="1.6">Διπλό low‑e (U≈1.6)</option>
              <option value="1.3">Διπλό low‑e + Argon (U≈1.3)</option>
              <option value="1.0">Τριπλό low‑e (U≈1.0)</option>
              <option value="0.9">Τριπλό low‑e + Argon (U≈0.9)</option>
              <option value="custom">Custom</option>
</select>
          </div>
          <div><label>U window custom</label><input id="UwinCustom" type="number" step="0.1" value="2.8" disabled></div>
          <div>
            <label>SHGC</label>
            <select id="SHGCpreset">
              <option value="0.86">Μονό clear ~0.86</option>
              <option value="0.70" selected>Διπλό clear ~0.70</option>
              <option value="0.55">Διπλό low‑e ~0.55</option>
              <option value="0.40">Τριπλό low‑e ~0.40</option>
            </select>
          </div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn ghost" id="addWinGrp">+ Πρόσθεσε ομάδα παραθύρων</button>
        </div>
        <table class="table" id="winTable" style="margin-top:8px">
          <thead><tr><th>Προσανατολισμός</th><th>m²</th><th>Σκίαση</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted" style="margin-top:6px">Σκίαση: 1.0=καθόλου, 0.7=ελαφρά, 0.4=ισχυρή. Προσανατολισμοί: N, NE, E, SE, S, SW, W, NW.</div>
      </div>

      <!-- Οροφή / Δάπεδο -->
      <div class="section">
        <h2>Οροφή & Δάπεδο</h2>
        <div class="grid cols-3">
          <div>
            <label>U οροφής</label>
            <select id="UroofPreset">
              <option value="1.00">Πλάκα χωρίς μόνωση (1.00)</option>
              <option value="0.50">XPS ~5cm (0.50)</option>
              <option value="0.35" selected>XPS ~8cm (0.35)</option>
              <option value="0.25">XPS ~12cm (0.25)</option>
              <option value="0.20">XPS ~15cm (0.20)</option>
              <option value="0.18">XPS ~20cm (0.18)</option>
              <option value="custom">Custom</option>
</select>
          </div>
          <div><label>U roof custom</label><input id="UroofCustom" type="number" step="0.01" value="0.35" disabled></div>
          <div><label>% οροφής προς εξωτερικό</label><input id="RoofPctExt" type="number" step="1" value="100"></div>
        </div>
        <div class="grid cols-3" style="margin-top:8px">
          <div><label>% οροφής προς μη θερμαινόμενο</label><input id="RoofPctUnh" type="number" step="1" value="0"></div>
          <div><label>T μη θερμ. πάνω (°C)</label><input id="Tattic" type="number" step="0.5" value="35"></div>
          <div><label>% οροφής προς θερμαινόμενο</label><input id="RoofPctHeated" type="number" step="1" value="0"></div>
        </div>
        <div class="grid cols-3" style="margin-top:12px">
          <div>
            <label>U δαπέδου</label>
            <select id="UfloorPreset">
              <option value="p|1.50">Προς pilotis χωρίς μόνωση (1.50)</option>
              <option value="p|0.90">Προς pilotis ελαφρά μόνωση ~3cm (0.90)</option>
              <option value="p|0.50">Προς pilotis μόνωση ~5cm (0.50)</option>
              <option value="p|0.35">Προς pilotis μόνωση ~8cm (0.35)</option>
              <option value="p|0.25">Προς pilotis μόνωση ~12cm (0.25)</option>
              <option value="g|1.20">Προς έδαφος χωρίς μόνωση (1.20)</option>
              <option value="g|0.80">Προς έδαφος ελαφρά μόνωση ~3cm (0.80)</option>
              <option value="g|0.50" selected>Προς έδαφος μόνωση ~5cm (0.50)</option>
              <option value="g|0.35">Προς έδαφος μόνωση ~8cm (0.35)</option>
              <option value="g|0.25">Προς έδαφος μόνωση ~12cm (0.25)</option>
              <option value="custom">Custom</option>
</select>
          </div>
          <div><label>U floor custom</label><input id="UfloorCustom" type="number" step="0.01" value="0.50" disabled></div>
          <div><label>% δαπέδου προς έδαφος/πιλοτή</label><input id="FloorPctGround" type="number" step="1" value="100"></div>
        </div>
        <div class="grid cols-3" style="margin-top:8px">
          <div><label>% δαπέδου προς μη θερμαινόμενο</label><input id="FloorPctUnh" type="number" step="1" value="0"></div>
          <div><label>% δαπέδου προς θερμαινόμενο</label><input id="FloorPctHeated" type="number" step="1" value="0"></div>
          <div><label>T εδάφους (°C)</label><input id="Tground" type="number" step="0.5" value="15"></div>
        </div>
      </div>

      <!-- Αερισμοί / Εναλλαγές -->
      <div class="section">
        <h2>Αερισμοί</h2>
        <div class="grid cols-3">
          <div>
            <label>Διείσδυση (σχισμές)</label>
            <select id="ACHinf">
              <option value="0.3">Στεγανό κέλυφος (~0.3 ACH)</option>
              <option value="0.7" selected>Μέτριο (~0.7 ACH)</option>
              <option value="1.2">Παλαιό/διαρροές (~1.2 ACH)</option>
            </select>
          </div>
          <div>
            <label>Φυσικός αερισμός</label>
            <select id="ACHnat">
              <option value="0">Παράθυρα κλειστά</option>
              <option value="1">Ανάκλιση (~1 ACH)</option>
              <option value="3">Ανοιχτά (~3 ACH)</option>
            </select>
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Μηχανικός (λειτουργία)</label>
            <select id="MechMode">
              <option value="ach">Σε ACH</option>
              <option value="flow">Σε m³/h</option>
            </select>
          </div>
          <div><label>Μηχανικός (ACH)</label><input id="ACHmech" type="number" step="0.1" value="0"></div>
          <div><label>Μηχανικός (m³/h)</label><input id="Qmech" type="number" step="10" value="0"></div>
        </div>
      </div>

      <!-- Άνθρωποι / Εσωτερικά κέρδη -->
      <div class="section">
        <h2>Εσωτερικά Κέρδη</h2>
        <div class="grid cols-3">
          <div>
            <label>Άτομα</label><input id="nPeople" type="number" step="1" value="2">
          </div>
          <div>
            <label>Δραστηριότητα</label>
            <select id="PeopleActivity">
              <option value="75|55">Καθιστοί (S≈75 W, L≈55 W)</option>
              <option value="100|75" selected>Ελαφριά δραστηρ. (100/75)</option>
              <option value="130|95">Μέτρια (130/95)</option>
            </select>
          </div>
          <div>
            <label>Φωτισμός (W/m²)</label><input id="LightingWm2" type="number" step="1" value="8">
          </div>
        </div>

        <div class="section">
          <h2>Συσκευές</h2>
          <table class="table" id="devTable">
            <thead><tr><th>Συσκευή</th><th>Ισχύς (W)</th><th>Συντελεστής χρήσης</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="flex" style="margin-top:8px">
            <select id="devLib"></select>
            <button class="btn ghost" id="addDev">+ Πρόσθεσε</button>
          </div>
          <div class="grid cols-3" style="margin-top:8px">
            <div><label>Custom φορτίο (W)</label><input id="CustomW" type="number" step="10" value="0"></div>
            <div><label>Duty/Simultaneity (0–1)</label><input id="CustomDuty" type="number" step="0.05" value="1"></div>
            <div><label>—</label><button class="btn ghost" id="addCustom">Προσθήκη custom</button></div>
          </div>
          <div class="muted" style="margin-top:6px">Για <strong>μοτέρ</strong>: θερμότητα στο χώρο ≈ P<sub>nom</sub>/η. Default η≈0.83 * Duty.</div>
        </div>
      </div>

      <!-- Κουμπί & Αποτελέσματα -->
      <div class="section">
        <div class="flex"><button class="btn primary" id="btnCalc">Υπολογισμός</button></div>
        <div id="result" style="margin-top:12px"></div>
        <canvas id="pie" width="720" height="420" style="margin-top:10px"></canvas>
      </div>

    </div>
  </div>

<script>
(function(){
  const run = ()=>{
    const $ = id => document.getElementById(id);
    const on = (id, evt, fn)=>{ const el=$(id); if(!el){ console.warn(`#${id} not found to bind ${evt}`); return; } el.addEventListener(evt, fn); };
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const rho = 1.2; // kg/m³
    const cp = 1.006; // kJ/kgK
    const Patm = 101.325; // kPa

    // --- Helpers ---
    function num(id, def=0){ const el=$(id); const v=parseFloat(el?.value); return isNaN(v)?def:v; }
    function str(id, def=''){ const el=$(id); return el?el.value:def; }
    function Uselect(presetId, customId){ const p=str(presetId,'custom'); return p==='custom'?num(customId):parseFloat(p); }
    function bindCustomToggle(presetId, customId){
      const ps = document.getElementById(presetId), cs = document.getElementById(customId);
      if(!ps || !cs) return;
      const apply = ()=>{ cs.disabled = (ps.value !== 'custom'); };
      ps.addEventListener('change', apply); apply();
    }

    function esat_kPa(T){ // Tetens-like (°C)
      return 0.61078 * Math.exp((17.27*T)/(T+237.3));
    }
    function humidityRatio(T, RH){ // RH in %
      const Pv = (RH/100) * esat_kPa(T); // kPa
      return 0.62198 * Pv / (Patm - Pv); // kg_w/kg_da
    }
    function enthalpy(T, w){ // kJ/kg_da
      return 1.006*T + w*(2501 + 1.86*T);
    }

    // --- Window groups ---
    const winTbody = document.querySelector('#winTable tbody');
    const orientations = [
      {k:'N', f:0.6}, {k:'NE', f:0.8}, {k:'E', f:0.9}, {k:'SE', f:1.0},
      {k:'S', f:1.0}, {k:'SW', f:1.1}, {k:'W', f:1.2}, {k:'NW', f:0.8}
    ];
    function addWinRow(o='W', area=3.0, shade=1.0){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><select class="wg-orient">${orientations.map(x=>`<option value="${x.k}" ${x.k===o?'selected':''}>${x.k}</option>`).join('')}</select></td>
                    <td><input class="wg-area" type="number" step="0.1" value="${area}"></td>
                    <td><input class="wg-shade" type="number" step="0.1" value="${shade}"></td>
                    <td><button class="btn ghost wg-del">✕</button></td>`;
      tr.querySelector('.wg-del').addEventListener('click',()=>tr.remove());
      winTbody.appendChild(tr);
    }
    on('addWinGrp','click',()=>addWinRow());
    // default four orientations
    addWinRow('S',1.5,0.7); addWinRow('W',2.0,1.0); addWinRow('E',1.0,1.0); addWinRow('N',0.5,1.0);

    // --- City datasets (summer/winter design, indicative)
    const cityData = {
      Athens: { cool:{T:36,RH:40}, heat:{T:2,RH:70}, ground:{cool:15, heat:12}, attic:{cool:35, heat:8}, adj:{cool:30, heat:12} },
      Thessaloniki: { cool:{T:35,RH:50}, heat:{T:0,RH:75}, ground:{cool:14, heat:10}, attic:{cool:34, heat:6}, adj:{cool:28, heat:10} },
      Patra: { cool:{T:34,RH:55}, heat:{T:3,RH:70}, ground:{cool:15, heat:12}, attic:{cool:34, heat:8}, adj:{cool:29, heat:12} },
      Heraklion: { cool:{T:33,RH:60}, heat:{T:7,RH:65}, ground:{cool:17, heat:14}, attic:{cool:35, heat:10}, adj:{cool:30, heat:14} }
    };

    // --- Devices library ---
    const devLib = [
      {name:'PC desktop', W:120}, {name:'Οθόνη', W:30}, {name:'TV LED 55"', W:120},
      {name:'Ψυγείο οικιακό', W:60}, {name:'Φούρνος μικροκυμάτων', W:1200},
      {name:'Εκτυπωτής laser', W:350}, {name:'Φορτιστής/μικροσυσκευές', W:50},
      {name:'Μοτέρ (default η=0.83)', W:1200, isMotor:true, Pnom:1000, eta:0.83}
    ];
    const devSel = document.getElementById('devLib');
    devLib.forEach((d,i)=>{ const op=document.createElement('option'); op.value=String(i); op.textContent=`${d.name} (${d.W} W)`; devSel?.appendChild(op); });
    if(devSel) devSel.selectedIndex = 0;
    const devTbody = document.querySelector('#devTable tbody');
    function addDevRow(dev){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${dev.name}${dev.isMotor?'<span class="chip">motor</span>':''}</td>
                    <td><input class="dv-W" type="number" step="10" value="${dev.W}"></td>
                    <td><input class="dv-duty" type="number" step="0.05" value="1"></td>
                    <td><button class="btn ghost dv-del">✕</button></td>`;
      tr.querySelector('.dv-del').addEventListener('click',()=>tr.remove());
      devTbody.appendChild(tr);
    }
    on('addDev','click',()=>{ const d = devLib[parseInt(devSel?.value)||0]; if(d) addDevRow(d); });
    on('addCustom','click',()=>{ const W = num('CustomW',0)*clamp(num('CustomDuty',1),0,1); if(W>0) addDevRow({name:'Custom', W:W}); });

    // --- City & Mode change helpers
    function applyCityAndMode(){
      const mode = str('Mode','cool');
      const cityVal = document.getElementById('city')?.value || 'Custom';
      if(cityVal==='Custom') return; // μην πειράξεις custom
      const key = cityVal.split('|')[0];
      const cd = cityData[key];
      if(!cd) return;
      const ext = cd[mode==='cool'?'cool':'heat'];
      const ToutEl = document.getElementById('Tout');
      const RHoutEl = document.getElementById('RHout');
      if(ToutEl) ToutEl.value = String(ext.T);
      if(RHoutEl) RHoutEl.value = String(ext.RH);
      // γειτονικές/έδαφος/σοφίτα defaults κατά λειτουργία (πάντα editable)
      const TadjEl = document.getElementById('Tadj');
      const TgroundEl = document.getElementById('Tground');
      const TatticEl = document.getElementById('Tattic');
      if(TadjEl) TadjEl.value = String(cd.adj[mode==='cool'?'cool':'heat']);
      if(TgroundEl) TgroundEl.value = String(cd.ground[mode==='cool'?'cool':'heat']);
      if(TatticEl) TatticEl.value = String(cd.attic[mode==='cool'?'cool':'heat']);
    }
    const cityEl = document.getElementById('city');
    cityEl?.addEventListener('change',applyCityAndMode);

    function applyInternalSetpoints(){
      const mode = str('Mode','cool');
      const TinEl = document.getElementById('Tin');
      const RHinEl = document.getElementById('RHin');
      if(TinEl && RHinEl){
        if(mode==='heat'){ TinEl.value = '22'; RHinEl.value = '40'; }
        else { TinEl.value = '24'; RHinEl.value = '45'; }
      }
    }
    document.getElementById('Mode')?.addEventListener('change', ()=>{ applyInternalSetpoints(); applyCityAndMode(); });

    function calc(){
      const L=num('L'), Wm=num('W'), H=num('H');
      const V=L*Wm*H; // m³

      const mode=str('Mode','cool');
      const toUnits=str('Units','W');

      const Tin=num('Tin'), RHin=num('RHin');
      const Tout=num('Tout'), RHout=num('RHout');
      const signDT = mode==='cool' ? (Tout - Tin) : (Tin - Tout); // ≥0 επιδιώκουμε
      const dT_base = Math.max(0, signDT);

      const winU = (str('UwinPreset')==='custom')? num('UwinCustom',2.8) : parseFloat(str('UwinPreset'));
      const SHGC = parseFloat(str('SHGCpreset'));

      // --- Walls
      const Uwall = (str('UwallPreset')==='custom')? num('UwallCustom',0.7) : parseFloat(str('UwallPreset'));
      const Lext=num('LwallExt',0), Lunh=num('LwallUnh',0); const Tadj=num('Tadj', mode==='cool'?30:12);
      const Aext = Lext*H; const Aunh=Lunh*H;

      // Windows groups
      const orientMap = {N:120, NE:220, E:350, SE:380, S:400, SW:450, W:500, NW:220}; // W/m² incident (τυπικό καλοκαιριού)
      let Awin_ext=0, Qwin_cond=0, Qwin_solar=0;
      document.querySelectorAll('#winTable tbody tr').forEach(tr=>{
        const o=tr.querySelector('.wg-orient').value; const a=parseFloat(tr.querySelector('.wg-area').value)||0; const sh=parseFloat(tr.querySelector('.wg-shade').value)||1;
        Awin_ext += a; // μόνο εξωτερικό
        Qwin_cond += a * winU * dT_base; // και στις δύο λειτουργίες αγώγιμο
        if(mode==='cool'){
          Qwin_solar += a * SHGC * (orientMap[o]||350) * clamp(sh,0,1);
        }
      });

      // Subtract windows area from external wall area
      const Aext_net = Math.max(0, Aext - Awin_ext);

      const Qwalls_ext = Aext_net * Uwall * dT_base; // sensible
      const dT_unh = Math.max(0, (mode==='cool' ? (Tadj - Tin) : (Tin - Tadj)));
      const Qwalls_unh = Aunh * Uwall * dT_unh; // προς μη θερμαινόμενο

      // --- Roof/Floor
      const Aroof=L*Wm, Afloor=L*Wm;
      const Uroof=(str('UroofPreset')==='custom')? num('UroofCustom',0.35):parseFloat(str('UroofPreset'));

      // U δαπέδου: επιτρέπει "g|0.50" (προς έδαφος) ή "p|0.50" (προς pilotis), για να ξέρουμε ποιο ΔΤ να εφαρμόσουμε.
      const ufSel = str('UfloorPreset');
      let Ufloor = 0.5;
      let floorBoundary = 'ground'; // 'ground' | 'pilotis'
      if(ufSel==='custom'){
        Ufloor = num('UfloorCustom',0.5);
      } else if(String(ufSel).includes('|')){
        const parts = String(ufSel).split('|');
        const b = (parts[0]||'g').trim().toLowerCase();
        const u = parseFloat(parts[1]);
        Ufloor = isNaN(u) ? 0.5 : u;
        floorBoundary = (b==='p') ? 'pilotis' : 'ground';
      } else {
        const u = parseFloat(ufSel);
        Ufloor = isNaN(u) ? 0.5 : u;
        floorBoundary = 'ground';
      }
      const RoofPctExt=clamp(num('RoofPctExt',100)/100,0,1), RoofPctUnh=clamp(num('RoofPctUnh',0)/100,0,1), RoofPctHeated=clamp(num('RoofPctHeated',0)/100,0,1);
      const FloorPctGround=clamp(num('FloorPctGround',100)/100,0,1), FloorPctUnh=clamp(num('FloorPctUnh',0)/100,0,1), FloorPctHeated=clamp(num('FloorPctHeated',0)/100,0,1);
      const Tattic=num('Tattic', mode==='cool'?35:8), Tground=num('Tground', mode==='cool'?15:12);

      // προς εξωτερικό/σοφίτα
      const dT_roof_ext = dT_base; // εξωτερικό
      const dT_roof_unh = Math.max(0, mode==='cool' ? (Tattic - Tin) : (Tin - Tattic));
      const Qroof_ext = (Aroof*RoofPctExt) * Uroof * dT_roof_ext;
      const Qroof_unh = (Aroof*RoofPctUnh) * Uroof * dT_roof_unh;
      const Qroof_heated = 0; // ίδια ζώνη ~0

      // Δάπεδο
      // - Προς έδαφος: το ΧΕΙΜΩΝΑ λαμβάνεται (Tin - Tground). Το ΚΑΛΟΚΑΙΡΙ το αγνοούμε (το έδαφος συνήθως είναι πιο ψυχρό).
      // - Προς pilotis: θεωρείται προς εξωτερικό (dT_base) και λαμβάνεται ΚΑΙ σε θέρμανση ΚΑΙ σε ψύξη.
      const dT_floor_ground = (floorBoundary==='pilotis')
        ? dT_base
        : (mode==='cool' ? 0 : Math.max(0, (Tin - Tground)));

      const dT_floor_unh = Math.max(0, mode==='cool' ? (Tadj - Tin) : (Tin - Tadj));

      const Qfloor_ground = (Afloor*FloorPctGround) * Ufloor * dT_floor_ground;
      const Qfloor_unh = (Afloor*FloorPctUnh) * Ufloor * dT_floor_unh;
      const Qfloor_heated = 0;

      // --- Ventilation / Infiltration (sensible & latent)
      const ACHinf=parseFloat(str('ACHinf'))||0; const ACHnat=parseFloat(str('ACHnat'))||0;
      const MechMode=str('MechMode','ach'); let ACHmech=0; let Qmech=num('Qmech',0)/3600; // m³/s
      if(MechMode==='ach'){ ACHmech = num('ACHmech',0); } else { ACHmech = 0; }
      const Vdot = ((ACHinf+ACHnat+ACHmech)*V/3600) + Qmech; // m³/s total
      const mdot = Vdot * rho; // kg/s

      const win = humidityRatio(Tin,RHin); const wout = humidityRatio(Tout,RHout);
      const hin = enthalpy(Tin,win); const hout = enthalpy(Tout,wout);

      const dT_vent = Math.abs(Tout - Tin);
      const Qvent_sens = mdot * cp * dT_vent * 1000; // W (πάντα θετικό)
      let Qvent_lat = 0;
      if(mode==='cool'){
        const Qvent_total = mdot * Math.max(0, (hout - hin)) * 1000; // μόνο όταν προστίθεται φορτίο
        Qvent_lat = Math.max(0, Qvent_total - Qvent_sens);
      }

      // --- Νωπός αέρας (μηχανικός μόνο) για sizing ψυχρομετρίας ΚΚΜ
      const Vdot_mech = ((ACHmech*V)/3600) + Qmech; // m³/s
      const mdot_mech = Vdot_mech * rho; // kg/s
      const Qmech_sens = mdot_mech * cp * dT_vent * 1000; // W
      let Qmech_lat = 0;
      if(mode==='cool'){
        const Qmech_total = mdot_mech * Math.max(0, (hout - hin)) * 1000; // W
        Qmech_lat = Math.max(0, Qmech_total - Qmech_sens);
      }

      // --- Internals: People / Lighting / Devices
      const nPeople=num('nPeople',0); const [Ps,Pl] = str('PeopleActivity','100|75').split('|').map(parseFloat);
      const Qpeople_sens_cool = nPeople * Ps; const Qpeople_lat_cool = nPeople * Pl;
      const Qlighting_cool = num('LightingWm2',8) * Afloor; // W
      let Qdevices = 0; document.querySelectorAll('#devTable tbody tr').forEach(tr=>{ const Wv=parseFloat(tr.querySelector('.dv-W').value)||0; const duty=clamp(parseFloat(tr.querySelector('.dv-duty').value)||1,0,1); Qdevices += Wv*duty; });

      // Windows total
      const Qwindows_sens = Qwin_cond + (mode==='cool'? Qwin_solar : 0);

      // Breakdown ανά λειτουργία
      let sensParts={}, latentParts={};
      if(mode==='cool'){
        sensParts = {
          'Τοίχοι εξωτερικοί': Qwalls_ext,
          'Τοίχοι προς μη θερμ.': Qwalls_unh,
          'Οροφή προς εξωτερικό': Qroof_ext,
          'Οροφή προς μη θερμ.': Qroof_unh,
          'Παράθυρα (αγώγιμα)': Qwin_cond,
          'Παράθυρα (ηλιακά)': Qwin_solar,
          'Δάπεδο προς έδαφος': Qfloor_ground,
          'Δάπεδο προς μη θερμ.': Qfloor_unh,
          'Αερισμός (αισθητό)': Qvent_sens,
          'Φωτισμός': Qlighting_cool,
          'Συσκευές': Qdevices,
          'Άνθρωποι (αισθητό)': Qpeople_sens_cool
        };
        latentParts = {
          'Αερισμός (λανθάνον)': Qvent_lat,
          'Άνθρωποι (λανθάνον)': Qpeople_lat_cool
        };
      } else { // ΘΕΡΜΑΝΣΗ — ΜΟΝΟ απώλειες, χωρίς αντιστάθμιση κερδών
        sensParts = {
          'Τοίχοι εξωτερικοί (απώλειες)': Qwalls_ext,
          'Τοίχοι προς μη θερμ. (απώλειες)': Qwalls_unh,
          'Οροφή προς εξωτερικό (απώλειες)': Qroof_ext,
          'Οροφή προς μη θερμ. (απώλειες)': Qroof_unh,
          'Παράθυρα (αγώγιμες απώλειες)': Qwin_cond,
          'Δάπεδο προς έδαφος (απώλειες)': Qfloor_ground,
          'Δάπεδο προς μη θερμ. (απώλειες)': Qfloor_unh,
          'Αερισμός/Διείσδυση (αισθητό)': Qvent_sens
        };
        latentParts = {}; // αγνοούμε λανθάνον στη θέρμανση
      }

      const Qsens = Object.values(sensParts).reduce((a,b)=>a+b,0);
      const Qlat = Object.values(latentParts).reduce((a,b)=>a+b,0);
      const Qtotal = Qsens + Qlat;

      // --- Render output ---
      const toU = (x)=> toUnits==='kW' ? `${(x/1000).toFixed(2)} kW` : `${x.toFixed(0)} W`;
      function list(parts){
        return Object.entries(parts)
          .filter(([,v])=>v>1)
          .map(([k,v])=>`<div class="rowline"><span>${k}</span><span>${toU(v)}</span></div>`)
          .join('');
      }

      const resultEl = document.getElementById('result');
      if(resultEl){
        const title = mode==='cool' ? 'Φορτίο Ψύξης' : 'Απώλειες Θέρμανσης (χωρίς κέρδη)';
        const latentBlock = mode==='cool' ? `<div class="section"><h2>Ανάλυση Λανθάνοντος</h2>${list(latentParts)}</div>` : '';
        const note = mode==='cool'? '' : `<div class="warn">Στη θέρμανση αγνοούνται εσωτερικά κέρδη (άνθρωποι/φωτισμός/συσκευές) και ηλιακά στα παράθυρα. Υπολογίζονται μόνο απώλειες μεταφοράς/αγωγιμότητας και αερισμός/διείσδυση (αισθητό).</div>`;

        const sumsBlock = `<div class="section"><h2>Σύνολα</h2>
            <div class="rowline"><span>Συνολικό Αισθητό</span><span id="sumQsVal" data-w="${Qsens}">${toU(Qsens)}</span></div>
            <div class="rowline"><span>Συνολικό Λανθάνον</span><span id="sumQlVal" data-w="${Qlat}">${toU(Qlat)}</span></div>
          </div>`;

        const mechBlock = (Vdot_mech>0)
          ? `<div class="section"><h2>Νωπός αέρας (μηχανικός) για ψυχρομετρία</h2>
               <div class="rowline"><span>Παροχή V̇ (μηχανικός)</span><span>${(Vdot_mech*3600).toFixed(0)} m³/h</span></div>
               <div class="rowline"><span>Αισθητό (μηχανικός)</span><span>${toU(Qmech_sens)}</span></div>
               <div class="rowline"><span>Λανθάνον (μηχανικός)</span><span>${toU(Qmech_lat)}</span></div>
             </div>`
          : '';

        resultEl.innerHTML = `
          <div class="kpi"><div class="muted">${title}</div><b>${toU(Qtotal)}</b></div>
          <div class="section"><h2>${mode==='cool'?'Ανάλυση Αισθητού':'Ανάλυση Απωλειών (Αισθητό)'}</h2>${list(sensParts)}</div>
          ${latentBlock}
          ${sumsBlock}
          ${mechBlock}
          ${note}
        `;
      }

      // Pie μέσα στη calc, με local δεδομένα
      drawPie('pie', sensParts, latentParts);
    }

    function drawPie(id, sens, lat){
      const canvas=document.getElementById(id); if(!canvas) return;
      const ctx=canvas.getContext('2d');
      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
      const data = {...sens, ...lat};
      const total = Object.values(data).reduce((a,b)=>a+b,0) || 1;
      let start=0; const cx=180, cy=210, r=140;
      const keys=Object.keys(data);
      keys.forEach((k,i)=>{
        const val=data[k]; const ang = (val/total)*Math.PI*2;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+ang); ctx.closePath();
        const hue = Math.floor((i/keys.length)*300);
        ctx.fillStyle = `hsl(${hue} 60% 50% / 0.9)`; ctx.fill();
        start += ang;
      });
      ctx.font='12px system-ui'; ctx.fillStyle='#ecf1ff';
      let y=20; const xL=360;
      keys.forEach((k,i)=>{
        const val=data[k]; if(val<1) return; const pct=(val/total*100).toFixed(1);
        const hue = Math.floor((i/keys.length)*300);
        ctx.fillStyle=`hsl(${hue} 60% 50% / 0.9)`; ctx.fillRect(xL,y-10,14,14);
        ctx.fillStyle='#ecf1ff'; ctx.fillText(`${k} — ${pct}%`, xL+20, y);
        y+=18;
      });
    }

    // Safe binds
    on('btnCalc','click', calc);
    bindCustomToggle('UwallPreset','UwallCustom');
    bindCustomToggle('UwinPreset','UwinCustom');
    bindCustomToggle('UroofPreset','UroofCustom');
    bindCustomToggle('UfloorPreset','UfloorCustom');

    // Sync "Ύψος χώρου (από πάνω)" με το H
    const syncHDisplay = ()=>{ const hEl=$('H'); const hd=$('H_display'); if(hEl && hd){ hd.value = hEl.value; } };
    on('H','input', syncHDisplay);
    syncHDisplay();

    // Initial calc
    applyCityAndMode();
    (function initSetpoints(){ const m = str('Mode','cool'); if(m==='heat'){ $('Tin').value='22'; $('RHin').value='40'; } else { $('Tin').value='24'; $('RHin').value='45'; } })();
    calc();

    // --- Self‑tests (console) ---
    try {
      console.assert(!!document.getElementById('btnCalc'), '#btnCalc should exist');
      const before = (document.getElementById('result')?.textContent||'').length;
      calc();
      const after = (document.getElementById('result')?.textContent||'').length;
      console.assert(after > before, 'calc() should render results');
    } catch(e){ console.warn('Self-test warning:', e); }
  };

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();
</script>

<!-- Ψυχρομετρικό overlay (δεν επηρεάζει τη σελίδα φορτίων) -->
<div id="psychroPane" style="display:none;position:fixed;inset:16px;z-index:999;background:linear-gradient(180deg,#181e32 0%,var(--card) 100%);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);overflow:auto;padding:14px">
  <div class="flex" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">Ψυχρομετρία – Σύνοψη δεδομένων</h2>
    <button id="closePsychro" class="btn ghost" style="width:auto;padding:8px 12px">← Επιστροφή στα Φορτία</button>
  </div>
  <div class="muted" style="margin:6px 0 12px">Τραβάει live τα input από τη σελίδα των φορτίων. Δεν αλλάζει τίποτα στον αρχικό υπολογισμό.</div>
  <div id="psychroSummary" class="card" style="margin-bottom:12px"></div>
  <div class="card" style="margin-top:8px">
  <h3 style="margin:0 0 8px;font-size:1rem">Παράμετροι Μίξης & Στοιχείου</h3>
  <div class="grid cols-3">
    <div>
      <label>Κατάσταση προσαγωγής – Τρόπος</label>
      <select id="PS_Mode">
        <option value="fixT" selected>Σταθερή Tsa</option>
        <option value="fixRH">Σταθερό RHsa% (με γνωστό SA)</option>
      </select>
    </div>
    <div>
      <label>Coil model (ADP/BF)</label>
      <select id="PS_CoilModel">
        <option value="none" selected>Use Supply state (Tsa/RHsa)</option>
        <option value="rows">Give Rows → estimate ADP/BF</option>
      </select>
    </div>

    <div>
      <label>T προσαγωγής Tsa (°C)</label>
      <input id="PS_Tsa" type="number" step="0.1" value="14">
    </div>
    <div>
      <label>RH προσαγωγής</label>
      <select id="PS_SA_RH_mode">
        <option value="sat" selected>Κορεσμός 100%</option>
        <option value="roomw">Ίδιο w με χώρου</option>
        <option value="manual">Χειροκίνητο %</option>
      </select>
    </div>
  </div>

  <div class="grid cols-3" id="PS_rows_block" style="margin-top:8px; display:none;">
    <div>
      <label>Σειρές (rows)</label>
      <select id="PS_rows">
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
        <option value="6">6</option>
      </select>
    </div>
    <div>
      <label>FPI (fins/in) – προαιρετικό</label>
      <select id="PS_fpi">
        <option value="8">8</option>
        <option value="10" selected>10</option>
        <option value="12">12</option>
      </select>
    </div>
    <div>
      <label>Ταχύτητα προσώπου (m/s) – προαιρετικό</label>
      <input id="PS_faceV" type="number" step="0.1" value="2.0">
    </div>
  </div>

  <div class="grid cols-3" style="margin-top:8px">
    <div>
      <label>RHsa (%) όταν είναι χειροκίνητο</label>
      <input id="PS_RHsa" type="number" step="1" value="95">
    </div>
    <div>
      <label>Παροχή SA (m³/h) – προαιρετικό</label>
      <input id="PS_SA_manual" type="number" step="10" value="">
    </div>
    <div>
      <label>Υπερπαροχή/υπερπίεση (m³/h)</label>
      <input id="PS_Pressurization" type="number" step="10" value="0">
    </div>
  </div>
  <div class="grid cols-3" style="margin-top:8px">
    <div class="flex" style="align-items:flex-end">
      <button id="PS_Suggest_T" class="btn ghost" style="width:auto">Πρόταση Tsa</button>
      <span class="chip">από Qs & παροχή</span>
    </div>
    <div class="flex" style="align-items:flex-end">
      <button id="PS_Suggest_RH" class="btn ghost" style="width:auto">Πρόταση RHsa</button>
      <span class="chip">τυπικά 90–100%</span>
    </div>
    <div>
      <button id="PS_Recalc" class="btn primary">Επαναυπολογισμός μίξης/στοιχείου</button>
    </div>
  </div>
</div>
<div id="psychroMix" class="card" style="margin:12px 0"></div>
</div>

<script>
// --- Lightweight tabs/overlay wiring (δεν αγγίζει την υπάρχουσα calc) ---
(function(){
  const $ = (id)=>document.getElementById(id);
  const pane = $('psychroPane');
  const btnOpen = $('tabPsychro');
  const btnClose = $('closePsychro');
  const btnLoads = $('tabLoads');
  const summary = $('psychroSummary');

  function fmt(x, unit){ return unit==='kW' ? (x/1000).toFixed(2)+' kW' : Math.round(x)+' W'; }

  // Μικρός τοπικός υπολογισμός μόνο για ψυχρομετρική σύνοψη
  function snapshot(){
    try {
      const rho=1.2, cp=1.006, Patm=101.325;
      const esat = T => 0.61078*Math.exp((17.27*T)/(T+237.3));
      const w = (T,RH)=>{ const Pv=(RH/100)*esat(T); return 0.62198*Pv/(Patm-Pv); };
      const h = (T,wr)=>1.006*T + wr*(2501 + 1.86*T);

      const Units = document.getElementById('Units')?.value || 'W';
      const Mode  = document.getElementById('Mode')?.value || 'cool';
      const L = parseFloat(document.getElementById('L')?.value||0);
      const Wm= parseFloat(document.getElementById('W')?.value||0);
      const H = parseFloat(document.getElementById('H')?.value||0);
      const V = L*Wm*H;

      const Tin = parseFloat(document.getElementById('Tin')?.value||24);
      const RHin= parseFloat(document.getElementById('RHin')?.value||45);
      const Tout = parseFloat(document.getElementById('Tout')?.value||36);
      const RHout= parseFloat(document.getElementById('RHout')?.value||40);

      const MechMode = document.getElementById('MechMode')?.value || 'ach';
      const ACHmech = (MechMode==='ach') ? parseFloat(document.getElementById('ACHmech')?.value||0) : 0;
      const Qmech_m3h = (MechMode==='flow') ? parseFloat(document.getElementById('Qmech')?.value||0) : 0;

      const Vdot_mech = (ACHmech*V/3600) + (Qmech_m3h/3600); // m³/s
      const mdot_mech = Vdot_mech * rho; // kg/s

      const win = w(Tin,RHin), wout = w(Tout,RHout);
      const hin = h(Tin,win), hout = h(Tout,wout);

      const dT = Math.abs(Tout - Tin);
      const Qmech_sens = mdot_mech * cp * dT * 1000; // W
      const Qmech_total = (Mode==='cool') ? mdot_mech * Math.max(0,(hout-hin)) * 1000 : 0; // W
      const Qmech_lat = (Mode==='cool') ? Math.max(0, Qmech_total - Qmech_sens) : 0;

      // Πάρε «Συνολικό Αισθητό/Λανθάνον» από το ήδη rendered αποτέλεσμα (χωρίς να ξαναγράφουμε calc)
      let Qsens=NaN, Qlat=NaN, Qtotal=NaN;
      const txt = document.getElementById('result')?.innerText||'';
      const m = txt.match(/Συνολικό Αισθητό\s+(\d+(?:\.\d+)?)\s*(kW|W)[\s\S]*?Συνολικό Λανθάνον\s+(\d+(?:\.\d+)?)\s*(kW|W)/);
      if(m){
        const sVal = parseFloat(m[1]); const sUnit = m[2];
        const lVal = parseFloat(m[3]); const lUnit = m[4];
        Qsens = (sUnit==='kW')? sVal*1000 : sVal;
        Qlat  = (lUnit==='kW')? lVal*1000 : lVal;
        Qtotal = Qsens + Qlat;
      }
      return {Units,Mode, Tin,RHin,win,hin, Tout,RHout,wout,hout, Vdot_mech,mdot_mech, Qmech_sens,Qmech_lat, Qsens,Qlat,Qtotal};
    } catch { return null; }
  }

  function renderSummary(){
    const s = snapshot();
    if(!s){ summary.innerHTML = '<div class="warn">Δεν ήταν δυνατή η δημιουργία σύνοψης.</div>'; return; }
    const U = s.Units;
    summary.innerHTML = `
      <div class="grid cols-3">
        <div class="kpi"><div class="muted">Εσωτερικό (RA)</div><b>${s.Tin.toFixed(1)} °C / ${s.RHin.toFixed(0)}% RH</b><div>w=${s.win.toFixed(4)} kg/kg</div><div>h=${s.hin.toFixed(1)} kJ/kg</div></div>
        <div class="kpi"><div class="muted">Εξωτερικό (OA)</div><b>${s.Tout.toFixed(1)} °C / ${s.RHout.toFixed(0)}% RH</b><div>w=${s.wout.toFixed(4)} kg/kg</div><div>h=${s.hout.toFixed(1)} kJ/kg</div></div>
        <div class="kpi"><div class="muted">Νωπός αέρας (μηχανικός)</div><b>${(s.Vdot_mech*3600).toFixed(0)} m³/h</b><div>ṁ=${s.mdot_mech.toFixed(3)} kg/s</div><div>Qs=${fmt(s.Qmech_sens,U)} · Ql=${fmt(s.Qmech_lat,U)}</div></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div class="kpi"><div class="muted">Σύνολα Φορτίων</div><b>${fmt(s.Qtotal||0, U)}</b><div>Αισθητό: ${fmt(s.Qsens||0, U)} · Λανθάνον: ${fmt(s.Qlat||0, U)}</div></div>
        <div class="kpi"><div class="muted">SHR (Room)</div><b>${(s.Qsens && s.Qtotal? (s.Qsens/(s.Qtotal))*100:0).toFixed(1)}%</b><div>Room SHR = Qs/(Qs+Ql)</div></div>
      </div>
    `;
  }

  function openPane(){ renderSummary(); pane.style.display='block'; }
  function closePane(){ pane.style.display='none'; }

  if(btnOpen)  btnOpen.addEventListener('click', openPane);
  if(btnClose) btnClose.addEventListener('click', closePane);
  if(btnLoads) btnLoads.addEventListener('click', closePane);
})();
</script>

<script>
// Νέος υπολογισμός μίξης & στοιχείου χωρίς regex.
(function(){
  const $ = (id)=>document.getElementById(id);
  const pane = $('psychroPane');
  const out = $('psychroMix');

  // βασικές συναρτήσεις
  const rho=1.2, cp=1.006, Patm=101.325;
  const esat = T => 0.61078*Math.exp((17.27*T)/(T+237.3));
  const wTRH = (T,RH)=>{ const Pv=(RH/100)*esat(T); return 0.62198*Pv/(Patm-Pv); };
  const hTw  = (T,w)=> 1.006*T + w*(2501 + 1.86*T);
  const T_hw = (h,w)=> (h - 2501*w) / (1.006 + 1.86*w);
  const RH_Tw = (T,w)=>{ const Pv=(w*Patm)/(0.62198+w); const Ps=esat(T); return Math.max(0,Math.min(100,100*Pv/Ps)); };
  
  // ADP & Bypass Factor from process line between entering (T1,w1) and leaving (T2,w2)
  const ADP_BPF = (T1,w1,T2,w2)=>{
    if(!isFinite(T1)||!isFinite(w1)||!isFinite(T2)||!isFinite(w2)) return {Tadp:NaN,bpf:NaN};
    if(Math.abs(T2-T1)<1e-9) return {Tadp:NaN,bpf:NaN};
    const lineW = (T)=> w1 + (w2-w1)*((T - T1)/(T2 - T1));
    const f = (T)=> wTRH(T,100) - lineW(T); // wsat - process line
    // bracket Tadp between very cold and entering temp
    let lo=-20, hi=T1;
    let flo=f(lo), fhi=f(hi);
    // if no sign change, give up
    if(!isFinite(flo)||!isFinite(fhi) || flo*fhi>0) return {Tadp:NaN,bpf:NaN};
    for(let i=0;i<60;i++){
      const mid=(lo+hi)/2;
      const fmid=f(mid);
      if(!isFinite(fmid)) break;
      if(flo*fmid<=0){ hi=mid; fhi=fmid; }
      else { lo=mid; flo=fmid; }
    }
    const Tadp=(lo+hi)/2;
    const bpf = (T2 - Tadp)/(T1 - Tadp);
    return {Tadp, bpf};
  };

const fmtW = x => (document.getElementById('Units').value==='kW') ? (x/1000).toFixed(2)+' kW' : Math.round(x)+' W';

  function roomData(){
    const Mode=document.getElementById('Mode')?.value||'cool';
    const Tin = parseFloat(document.getElementById('Tin')?.value||24);
    const RHin= parseFloat(document.getElementById('RHin')?.value||45);
    const Tout=parseFloat(document.getElementById('Tout')?.value||36);
    const RHout=parseFloat(document.getElementById('RHout')?.value||40);
    const L=parseFloat(document.getElementById('L')?.value||0);
    const Wm=parseFloat(document.getElementById('W')?.value||0);
    const H=parseFloat(document.getElementById('H')?.value||0);
    const V=L*Wm*H;
    const MechMode=document.getElementById('MechMode')?.value||'ach';
    const ACHmech=(MechMode==='ach')? parseFloat(document.getElementById('ACHmech')?.value||0):0;
    const Qmech_m3h=(MechMode==='flow')? parseFloat(document.getElementById('Qmech')?.value||0):0;
    const Voa_m3s=(ACHmech*V/3600)+(Qmech_m3h/3600);

    // από τα σύνολα που ήδη renderάρονται, μέσω data attributes
    const qsSpan=document.getElementById('sumQsVal');
    const qlSpan=document.getElementById('sumQlVal');
    const Qsens = qsSpan? parseFloat(qsSpan.getAttribute('data-w')||'NaN') : NaN;
    const Qlat  = qlSpan? parseFloat(qlSpan.getAttribute('data-w')||'NaN') : NaN;
    return {Mode,Tin,RHin,Tout,RHout,Voa_m3s,Qsens,Qlat};
  }

  function compute(){
    const R = roomData();
    if(R.Mode!=="cool"){ out.innerHTML='<div class="warn">Η ανάλυση στοιχείου ενεργή μόνο σε Ψύξη.</div>'; return; }
    if(!isFinite(R.Qsens)){ out.innerHTML='<div class="warn">Πάτησε «Υπολογισμός» στα Φορτία για να έχουμε Qs/Ql.</div>'; return; }

    const modelNow = $('PS_CoilModel')?.value || 'none';
    const blkNow = $('PS_rows_block');
    if(blkNow) blkNow.style.display = (modelNow==='rows') ? 'grid' : 'none';

    const Tsa_in = parseFloat(($('PS_Tsa')?.value)||14);
    const RHmode = $('PS_SA_RH_mode')?.value||'sat';
    const RHsa_man = parseFloat(($('PS_RHsa')?.value)||95);
    const SA_m3h_in = parseFloat(($('PS_SA_manual')?.value)||'');
    const press_m3h = parseFloat(($('PS_Pressurization')?.value)||0);
    const modeSel = $('PS_Mode')?.value||'fixT';

    const win  = wTRH(R.Tin,  R.RHin);
    const wout = wTRH(R.Tout, R.RHout);
    const hin  = hTw(R.Tin,  win);
    const hout = hTw(R.Tout, wout);


    // Υπόθεση: αν δεν δώθηκε SA, θα προκύψει από Qsens και Tsa
    let Vsa_m3s;
    const Voa_m3s = Math.max(0,R.Voa_m3s);

    if(isFinite(SA_m3h_in) && SA_m3h_in>0){
      Vsa_m3s = SA_m3h_in/3600;
    } else {
      // Auto-size supply airflow based on TOTAL (sensible+latent) cooling using mixed-air enthalpy.
      // This avoids the classic sensible-only under-sizing and fixes coil/psychro inconsistencies.
      const Qtarget = Math.max(0,(R.Qsens||0) + (R.Qlat||0)); // W

      if(modeSel!=='fixT' || Qtarget<=0){
        // Fallback to sensible-only if we don't have a defined leaving state.
        const mdot_sa_s = R.Qsens/(cp*1000*Math.max(0.1,(R.Tin - Tsa_in)));
        Vsa_m3s = mdot_sa_s/rho;
      } else {
        // Leaving state for fixed Tsa
        let wsa0;
        if(RHmode==='sat'){ wsa0 = wTRH(Tsa_in,100); }
        else if(RHmode==='roomw'){ wsa0 = win; }
        else { const r=Math.max(5,Math.min(100,RHsa_man)); wsa0 = wTRH(Tsa_in,r); }
        const hsa0 = hTw(Tsa_in,wsa0);

        // Solve Vsa such that Qtarget ~= m_dot_sa*(h_mix(Vsa)-h_sa)*1000
        const QfromVsa = (Vsa)=>{
          const Vrec = Math.max(0, Vsa - Voa_m3s);
          const mdot_oa=Voa_m3s*rho, mdot_ra=Vrec*rho, mdot_sa=Vsa*rho;
          const denom=Math.max(1e-9,(mdot_oa+mdot_ra));
          const hmix=(mdot_oa*hout + mdot_ra*hin)/denom;
          return mdot_sa*Math.max(0,(hmix - hsa0))*1000; // W
        };

        let lo = Math.max(Voa_m3s, 0.05);   // m3/s
        let hi = Math.max(lo*2, 0.5);       // m3/s
        // Expand upper bound until it can meet the load (or until unreasonable)
        for(let k=0;k<30;k++){
          if(QfromVsa(hi) >= Qtarget) break;
          hi *= 1.6;
          if(hi > 25) break; // hard cap (m3/s)
        }
        // Bisection
        for(let i=0;i<50;i++){
          const mid=(lo+hi)/2;
          const Qm=QfromVsa(mid);
          if(Qm >= Qtarget) hi=mid; else lo=mid;
        }
        Vsa_m3s = hi;
      }
    }

    const Vrec_m3s = Math.max(0,Vsa_m3s - Voa_m3s);
    const mdot_oa=Voa_m3s*rho, mdot_ra=Vrec_m3s*rho, mdot_sa=Vsa_m3s*rho;

    const wmix=(mdot_oa*wout + mdot_ra*win)/Math.max(1e-9,(mdot_oa+mdot_ra));
    const hmix=(mdot_oa*hout + mdot_ra*hin)/Math.max(1e-9,(mdot_oa+mdot_ra));
    const Tmix=T_hw(hmix,wmix);
    const RHmix=RH_Tw(Tmix,wmix);

    const coilModel = $('PS_CoilModel')?.value || 'none';

    let Tsa=Tsa_in, wsa, RHsa, hsa;
    // Rows-based coil model: estimate BPF from rows/face velocity and compute leaving humidity from ADP/BPF.
    let Tadp_est = NaN, BPF_est = NaN;

    if(modeSel==='fixT'){
      if(coilModel==='rows'){
        const rows = parseFloat(($('PS_rows')?.value)||'3');
        const faceV = parseFloat(($('PS_faceV')?.value)||'2.0');
        // Typical BPF by rows (comfort AHU coil sizing, indicative)
        const base = ({2:0.30,3:0.22,4:0.16,6:0.08})[rows] ?? 0.20;
        // Higher face velocity -> worse (higher) BPF
        BPF_est = Math.max(0.03, Math.min(0.60, base * Math.sqrt(Math.max(0.5, faceV)/2.0)));
        // Tadp consistent with leaving Tsa
        Tadp_est = (Tsa - BPF_est*Tmix) / Math.max(1e-6,(1 - BPF_est));
        // Saturated humidity ratio at ADP
        const wadp = wTRH(Tadp_est, 100);
        // Leaving humidity ratio from bypass mixing
        wsa = BPF_est*wmix + (1 - BPF_est)*wadp;
        RHsa = RH_Tw(Tsa, wsa);
        hsa = hTw(Tsa, wsa);
      } else {
        if(RHmode==='sat'){ RHsa=100; wsa=wTRH(Tsa,100); }
      else if(RHmode==='roomw'){ wsa=win; RHsa=RH_Tw(Tsa,wsa); }
      else { const r=Math.max(5,Math.min(100,RHsa_man)); RHsa=r; wsa=wTRH(Tsa,r); }
      hsa=hTw(Tsa,wsa);
      }
    } else { // fixRH
      if(!(isFinite(SA_m3h_in)&&SA_m3h_in>0)){ out.innerHTML='<div class="warn">Για σταθερό RHsa% δώσε παροχή SA (m³/h).</div>'; return; }
      const r=Math.max(5,Math.min(100,RHsa_man));
      Tsa = Tmix - (R.Qsens/(mdot_sa*cp*1000));
      wsa=wTRH(Tsa,r); RHsa=r; hsa=hTw(Tsa,wsa);
    }

    const Qcoil_tot = mdot_sa * Math.max(0,(hmix - hsa)) * 1000;
    const Qcoil_sens = mdot_sa * Math.max(0,(Tmix - Tsa)) * cp * 1000;
    const Qcoil_lat = Math.max(0,Qcoil_tot - Qcoil_sens);


    // ADP & Bypass Factor
    let Tadp = NaN, BPF = NaN;
    if(coilModel==='rows' && isFinite(Tadp_est) && isFinite(BPF_est)){
      Tadp = Tadp_est; BPF = BPF_est;
    } else {
      const adp = ADP_BPF(Tmix, wmix, Tsa, wsa);
      Tadp = adp.Tadp;
      BPF  = adp.bpf;
    }

    const Vsa_m3h=Vsa_m3s*3600, Voa_m3h=Voa_m3s*3600, Vrec_m3h=Vrec_m3s*3600;
    const exhaust_m3h = Math.max(0, Voa_m3h - press_m3h);
    const return_m3h  = Math.max(0, Vsa_m3h - exhaust_m3h);

    out.innerHTML = `
      <div class="grid cols-3">
        <div class="kpi"><div class="muted">Παροχή προσαγωγής (SA)</div><b>${Vsa_m3h.toFixed(0)} m³/h</b><div>OA% στο Mix: ${((Voa_m3h/Math.max(1,Vsa_m3h))*100).toFixed(1)}%</div></div>
        <div class="kpi"><div class="muted">Mix @ coil inlet</div><b>${Tmix.toFixed(1)} °C</b><div>RH≈${RHmix.toFixed(0)}% · w=${wmix.toFixed(4)} kg/kg</div><div>h=${hmix.toFixed(1)} kJ/kg</div></div>
        <div class="kpi"><div class="muted">Supply (SA)</div><b>${Tsa.toFixed(1)} °C / ${RHsa.toFixed(0)}% RH</b><div>w=${wsa.toFixed(4)} kg/kg</div><div>h=${hsa.toFixed(1)} kJ/kg<div>ADP=${isFinite(Tadp)?Tadp.toFixed(1):"—"} °C · BPF=${isFinite(BPF)?Math.max(0,Math.min(1,BPF)).toFixed(2):"—"}</div></div></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="kpi"><div class="muted">Coil Load</div><b>${fmtW(Qcoil_tot)}</b><div>Qs=${fmtW(Qcoil_sens)} · Ql=${fmtW(Qcoil_lat)}</div></div>
        <div class="kpi"><div class="muted">Επιστροφή/Εξαγωγή</div><b>Return ≈ ${return_m3h.toFixed(0)} m³/h</b><div>Exhaust ≈ ${exhaust_m3h.toFixed(0)} m³/h</div></div>
        <div class="kpi"><div class="muted">Έλεγχος</div><b>${(Math.abs(Vsa_m3h - (Voa_m3h+Vrec_m3h))<1e-6)?'OK':'Check flows'}</b><div>SA = OA + Recirc</div></div>
      </div>`;
  }

  function suggestT(){
    const R=roomData(); if(R.Mode!=='cool') return;
    const SA_m3h_in=parseFloat(($('PS_SA_manual')?.value)||''); if(!(isFinite(SA_m3h_in)&&SA_m3h_in>0)) return;
    const win=wTRH(R.Tin,R.RHin), wout=wTRH(R.Tout,R.RHout);
    const hin=hTw(R.Tin,win), hout=hTw(R.Tout,wout);
    const Vsa=SA_m3h_in/3600, Voa=Math.max(0,R.Voa_m3s), Vrec=Math.max(0,Vsa - Voa);
    const mdot_oa=Voa*rho, mdot_ra=Vrec*rho; const mdot_sa=Vsa*rho;
    const wmix=(mdot_oa*wout + mdot_ra*win)/Math.max(1e-9,(mdot_oa+mdot_ra));
    const hmix=(mdot_oa*hout + mdot_ra*hin)/Math.max(1e-9,(mdot_oa+mdot_ra));
    const Tmix=T_hw(hmix,wmix);
    const Tsa = Tmix - (R.Qsens/(mdot_sa*cp*1000));
    const el=$('PS_Tsa'); if(el) el.value = (isFinite(Tsa)?Tsa:(R.Tin-10)).toFixed(1);
  }

  // κουμπιά
  const openBtn=document.getElementById('tabPsychro');
  const closeBtn=document.getElementById('closePsychro');
  const loadsBtn=document.getElementById('tabLoads');
  openBtn?.addEventListener('click', ()=>{ compute(); });
  $('PS_Recalc')?.addEventListener('click', compute);
  $('PS_CoilModel')?.addEventListener('change', ()=>{
    const model = $('PS_CoilModel')?.value || 'none';
    const blk = $('PS_rows_block');
    if(blk) blk.style.display = (model==='rows') ? 'grid' : 'none';
    compute();
  });
  $('PS_Suggest_T')?.addEventListener('click', ()=>{ suggestT(); compute(); });
  $('PS_Suggest_RH')?.addEventListener('click', ()=>{ const el=$('PS_RHsa'); if(el) el.value='95'; compute(); });

  // live refresh όταν αλλάζουν βασικά inputs κι είναι ανοιχτό
  ['Units','Mode','Tin','RHin','Tout','RHout','ACHmech','Qmech','MechMode','btnCalc'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    const fn=()=>{ if(pane && pane.style.display==='block') compute(); };
    el.addEventListener('change', fn); el.addEventListener('click', fn);
  });
})();
</script>
<script>
(function(){
  const $ = id => document.getElementById(id);
  const val = (id, d='') => ($(id)?.value ?? d);
  const num = (id, d=0) => { const v = parseFloat(val(id)); return isNaN(v)?d:v; };
  const txtSel = sel => {
    const el = document.querySelector(sel);
    return el?.options ? el.options[el.selectedIndex].text : (el?.textContent||'');
  };

  // --- 1) Πίτα με ΜΑΥΡΑ labels ΜΟΝΟ στο PDF (δεν αλλάζει το UI)
  function getPieImageBlackLabels(){
    const src = $('pie');
    if(!src || !src.width || !src.height) return '';
    const off = document.createElement('canvas');
    off.width = src.width; off.height = src.height;
    const ctx = off.getContext('2d');
    ctx.drawImage(src, 0, 0);
    const imgData = ctx.getImageData(0, 0, off.width, off.height);
    const d = imgData.data;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const lum = 0.2126*r + 0.7152*g + 0.0722*b; // perceived luminance
      if(lum > 200){ d[i]=d[i+1]=d[i+2]=0; } // πολύ ανοιχτό → μαύρο
    }
    ctx.putImageData(imgData, 0, 0);
    return off.toDataURL('image/png');
  }

  // --- 2) Πλήρες μπλοκ ΕΙΣΟΔΩΝ (Design Data)
  function buildFullInputsHTML(){
    const L=num('L'), W=num('W'), H=num('H'), V=L*W*H;
    const Uwall = (val('UwallPreset')==='custom')? val('UwallCustom'):val('UwallPreset');
    const Uroof = (val('UroofPreset')==='custom')? val('UroofCustom'):val('UroofPreset');
    const Ufloor = (val('UfloorPreset')==='custom')? val('UfloorCustom'):val('UfloorPreset');
    const Uwin  = (val('UwinPreset')==='custom') ? val('UwinCustom') : val('UwinPreset');
    const SHGC  = val('SHGCpreset');

    const winRows = [...document.querySelectorAll('#winTable tbody tr')].map(tr=>{
      const o = tr.querySelector('.wg-orient')?.value||'';
      const a = tr.querySelector('.wg-area')?.value||'';
      const s = tr.querySelector('.wg-shade')?.value||'';
      return `<tr><td>${o}</td><td class="r">${a}</td><td class="r">${s}</td></tr>`;
    }).join('');

    return `
      <h2>Είσοδοι (Design Data)</h2>
      <div class="grid-2">
        <table>
          <tr><th colspan="2">Γενικά</th></tr>
          <tr><td>Λειτουργία</td><td class="r">${val('Mode')==='cool'?'Ψύξη':'Θέρμανση'}</td></tr>
          <tr><td>Μονάδες</td><td class="r">${val('Units','W')}</td></tr>

          <tr><th colspan="2">Γεωμετρία</th></tr>
          <tr><td>L × W × H (m)</td><td class="r">${L} × ${W} × ${H}</td></tr>
          <tr><td>Όγκος V (m³)</td><td class="r">${isFinite(V)?V.toFixed(2):'—'}</td></tr>

          <tr><th colspan="2">Συνθήκες</th></tr>
          <tr><td>Εσωτερικό</td><td class="r">${val('Tin')} °C, ${val('RHin')}%</td></tr>
          <tr><td>Εξωτερικό</td><td class="r">${val('Tout')} °C, ${val('RHout')}%</td></tr>
          <tr><td>Πόλη (preset)</td><td class="r">${txtSel('#city')}</td></tr>

          <tr><th colspan="2">Αερισμοί</th></tr>
          <tr><td>Διείσδυση</td><td class="r">${val('ACHinf')} ACH</td></tr>
          <tr><td>Φυσικός</td><td class="r">${val('ACHnat')} ACH</td></tr>
          <tr><td>Μηχανικός</td><td class="r">${
            val('MechMode')==='ach' ? (val('ACHmech')+' ACH') : (val('Qmech')+' m³/h')
          }</td></tr>
        </table>

        <table>
          <tr><th colspan="2">Τοίχοι</th></tr>
          <tr><td>Uwall (W/m²K)</td><td class="r">${Uwall}</td></tr>
          <tr><td>Μήκος προς εξ./μη θερμ. (m)</td><td class="r">${val('LwallExt')} / ${val('LwallUnh')}</td></tr>
          <tr><td>T γειτονικού (°C)</td><td class="r">${val('Tadj')}</td></tr>

          <tr><th colspan="2">Οροφή</th></tr>
          <tr><td>Uroof (W/m²K)</td><td class="r">${Uroof}</td></tr>
          <tr><td>% εξ./μη θερμ./θερμ.</td><td class="r">${val('RoofPctExt')}% / ${val('RoofPctUnh')}% / ${val('RoofPctHeated')}%</td></tr>
          <tr><td>T σοφίτας (°C)</td><td class="r">${val('Tattic')}</td></tr>

          <tr><th colspan="2">Δάπεδο</th></tr>
          <tr><td>Ufloor (W/m²K)</td><td class="r">${Ufloor}</td></tr>
          <tr><td>% έδαφος/μη θερμ./θερμ.</td><td class="r">${val('FloorPctGround')}% / ${val('FloorPctUnh')}% / ${val('FloorPctHeated')}%</td></tr>
          <tr><td>T εδάφους (°C)</td><td class="r">${val('Tground')}</td></tr>

          <tr><th colspan="2">Παράθυρα</th></tr>
          <tr><td>Uwin (W/m²K)</td><td class="r">${Uwin}</td></tr>
          <tr><td>SHGC</td><td class="r">${SHGC}</td></tr>
        </table>
      </div>

      <div class="section">
        <h3>Ομάδες Παραθύρων</h3>
        <table>
          <tr><th>Προσανατολισμός</th><th class="r">m²</th><th class="r">Σκίαση</th></tr>
          ${winRows || '<tr><td colspan="3" class="muted">—</td></tr>'}
        </table>
      </div>

      <div class="section">
        <h3>Εσωτερικά Κέρδη</h3>
        <table>
          <tr><th>Παράμετρος</th><th class="r">Τιμή</th></tr>
          <tr><td>Άτομα</td><td class="r">${val('nPeople')}</td></tr>
          <tr><td>Δραστηριότητα (S/L)</td><td class="r">${val('PeopleActivity')}</td></tr>
          <tr><td>Φωτισμός (W/m²)</td><td class="r">${val('LightingWm2')}</td></tr>
        </table>
      </div>
    `;
  }

  // --- 3) Παραδοχές & Τύποι (συνοπτικά)
  function buildAssumptions(){
    return `
      <div class="section">
        <h2>Παραδοχές & Τύποι</h2>
        <div class="grid-2">
          <div class="kpi">ρ=1.2 kg/m³, c<sub>p</sub>=1.006 kJ/kgK, P<sub>atm</sub>=101.325 kPa</div>
          <div class="kpi">Q = U · A · ΔT</div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div class="kpi">V̇ = ((ACH<sub>inf</sub>+ACH<sub>nat</sub>+ACH<sub>mech</sub>)·V)/3600 + Q<sub>mech</sub>/3600</div>
          <div class="kpi">ṁ = ρ·V̇,  w = 0.62198·P<sub>v</sub>/(P<sub>atm</sub>−P<sub>v</sub>),  h = 1.006T + w(2501+1.86T)</div>
        </div>
      </div>
    `;
  }

  // --- 4) Export PDF (πλήρες)
  function exportPDF_full(){
    const resultEl = $('result');
    if(!resultEl || !resultEl.innerHTML.trim()){ alert('Πάτησε πρώτα «Υπολογισμός».'); return; }

    const w = window.open('', '_blank'); if(!w){ alert('Επέτρεψε popups.'); return; }

    const modeTxt = (val('Mode')==='cool')? 'Ψύξη':'Θέρμανση';
    const now = new Date().toLocaleString();

    const css = `
      <style>
        *{box-sizing:border-box}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111;margin:0;padding:16px}
        h1,h2,h3{margin:0 0 8px} h1{font-size:18px} h2{font-size:15px} h3{font-size:13px}
        .section{margin:12px 0 16px}
        .muted{color:#666}.small{font-size:11px}
        table{width:100%;border-collapse:collapse;font-size:12px}
        th,td{border:1px solid #ddd;padding:6px 8px;vertical-align:top}
        th{background:#f6f7fb;text-align:left}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .kpi{border:1px dashed #bbb;padding:8px;border-radius:8px;font-size:12px}
        .pagebreak{page-break-before:always}
        .hdr{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:8px}
        .chip{display:inline-block;padding:2px 8px;border:1px solid #999;border-radius:999px;font-size:10px;color:#333}
        .note{background:#fff3cd;border:1px solid #ffe08a;padding:8px;border-radius:6px;font-size:12px;color:#6b5600}
        .rowline{display:flex;align-items:center;gap:10px;border-bottom:1px dashed #e5e7ef;padding:6px 0;margin:0}
        .rowline span:first-child{flex:1;min-width:0}
        .rowline span:last-child{flex:0 0 140px;text-align:right;font-variant-numeric:tabular-nums;font-weight:600;color:#0c0f17}
        .r{text-align:right;font-variant-numeric:tabular-nums}
        @media print{ body{padding:12mm} }
      </style>
    `;

    // Πίτα με μαύρα labels
    const pieURL = getPieImageBlackLabels();
    const pieHTML = pieURL
      ? `<div class="section"><h3>Κατανομή φορτίων</h3><img src="${pieURL}" style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px;image-rendering:crisp-edges"/></div>`
      : '';

    // Ψυχρομετρία (αν υπάρχει)
    const psychroHTML = ($('psychroMix')?.innerHTML.trim()
        || `<div class="note">Δεν υπάρχουν διαθέσιμα δεδομένα ψυχρομετρίας.</div>`);

    const page1 = `
      <div class="hdr">
        <div>
          <h1>Αναφορά Υπολογισμού Φορτίων & Ψυχρομετρίας</h1>
          <div class="muted small">${now}</div>
        </div>
        <div class="chip">${modeTxt}</div>
      </div>

      ${buildFullInputsHTML()}
      ${buildAssumptions()}

      <div class="section">
        <h2>Αποτελέσματα Φορτίων</h2>
        ${resultEl.innerHTML}
      </div>

      ${pieHTML}
    `;

    const page2 = `
      <div class="pagebreak"></div>
      <h2>Ψυχρομετρική Ανάλυση</h2>
      ${psychroHTML}
    `;

    w.document.open();
    w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">${css}</head><body>${page1}${page2}</body></html>`);
    w.document.close();
    setTimeout(()=>{ w.focus(); w.print(); }, 250);
  }

  // --- 5) Κουμπιά «Εξαγωγή σε PDF» (δίπλα στο Υπολογισμός + στην ψυχρομετρία)
  function ensureExportButtons(){
    const calcBtn = $('btnCalc');
    if(calcBtn && !$('btnPDF_full')){
      const b = document.createElement('button');
      b.id='btnPDF_full'; b.className='btn ghost'; b.textContent='Εξαγωγή σε PDF';
      b.style.marginLeft='8px';
      calcBtn.parentElement.appendChild(b);
      b.addEventListener('click', exportPDF_full);
    }
    const recalcBtn = [...document.querySelectorAll('button')].find(x => (x.textContent||'').includes('Επαναυπολογισμός μίξης'));
    if(recalcBtn && !$('btnPDF_full_psy')){
      const b = document.createElement('button');
      b.id='btnPDF_full_psy'; b.className='btn ghost'; b.textContent='Εξαγωγή σε PDF';
      b.style.marginLeft='8px';
      recalcBtn.parentElement.appendChild(b);
      b.addEventListener('click', exportPDF_full);
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ensureExportButtons);
  } else {
    ensureExportButtons();
  }
  new MutationObserver(ensureExportButtons).observe(document.body, {childList:true,subtree:true});
})();
</script>
</body>
</html>
<script>
